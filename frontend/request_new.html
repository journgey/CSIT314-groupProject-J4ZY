<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Request</title>

  <!-- Project style sheets -->
  <link rel="stylesheet" href="static/css/theme.css" />
  <link rel="stylesheet" href="static/css/base.css" />
  <link rel="stylesheet" href="static/css/layout.css" />
</head>
<body>
  <!-- Optional: top navigation bar -->
  <nav class="navbar">
    <div class="container navbar-inner">
      <a href="accounts.html">Accounts</a>
      <a href="requests.html" aria-current="page">Requests</a>
      <a href="categories.html">Categories</a>
    </div>
  </nav>

  <main class="container page">
    <!-- Page header -->
    <header class="page-header">
      <h2 class="page-title">Create Request</h2>
      <div class="toolbar">
        <a href="requests.html" class="btn btn-outline">‚Üê Back</a>
      </div>
    </header>

    <!-- Form card -->
    <section class="card content">
      <form id="frm" class="content">
        <!-- PIN Account select -->
        <div class="input-group">
          <label for="pin_account_id">PIN Account</label>
          <select id="pin_account_id" required></select>
        </div>

        <!-- Category select -->
        <div class="input-group">
          <label for="category_id">Category</label>
          <select id="category_id">
            <option value="">(None)</option>
          </select>
        </div>

        <!-- Title input -->
        <div class="input-group">
          <label for="title">Title</label>
          <input id="title" required />
        </div>

        <!-- Description text area -->
        <div class="input-group">
          <label for="description">Description</label>
          <textarea id="description" rows="4"></textarea>
        </div>

        <!-- Status select -->
        <div class="input-group">
          <label for="status">Status</label>
          <select id="status">
            <option>OPEN</option>
            <option>IN_PROGRESS</option>
            <option>CLOSED</option>
          </select>
        </div>

        <!-- Form buttons -->
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Create</button>
          <a class="btn btn-outline" href="requests.html">Cancel</a>
        </div>
      </form>
    </section>
  </main>

  <!-- JS API helper -->
  <script src="static/js/api.js"></script>
  <script>
    /* Load account and category references */
    async function loadRefs() {
      const [accounts, categories] = await Promise.all([
        apiGet('/accounts/'),
        apiGet('/categories/')
      ]);

      const accSel = document.getElementById('pin_account_id');
      accSel.innerHTML = accounts
        .map(a => `<option value="${a.id}">${a.email} (${a.role})</option>`)
        .join('');

      const catSel = document.getElementById('category_id');
      catSel.innerHTML += categories
        .map(c => `<option value="${c.id}">${c.name}</option>`)
        .join('');
    }

    /* Handle form submission */
    document.getElementById('frm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Collect form data
      const dto = {
        pin_account_id: Number(document.getElementById('pin_account_id').value),
        category_id: document.getElementById('category_id').value
          ? Number(document.getElementById('category_id').value)
          : null,
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        status: document.getElementById('status').value
      };

      // Send POST request then redirect
      await apiJson('/requests/', 'POST', dto);
      location.href = 'requests.html';
    });

    // Initialize select options
    loadRefs();
  </script>
</body>
</html>

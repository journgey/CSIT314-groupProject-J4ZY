<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Edit Request</title>

  <!-- Project style sheets -->
  <link rel="stylesheet" href="static/css/theme.css" />
  <link rel="stylesheet" href="static/css/base.css" />
  <link rel="stylesheet" href="static/css/layout.css" />
</head>
<body>
  <!-- Optional: top navigation bar -->
  <nav class="navbar">
    <div class="container navbar-inner">
      <a href="accounts.html">Accounts</a>
      <a href="requests.html" aria-current="page">Requests</a>
      <a href="categories.html">Categories</a>
    </div>
  </nav>

  <main class="container page">
    <!-- Page header -->
    <header class="page-header">
      <h2 class="page-title">Edit Request</h2>
      <div class="toolbar">
        <a href="requests.html" class="btn btn-outline">‚Üê Back</a>
      </div>
    </header>

    <!-- Edit form -->
    <section class="card content">
      <form id="frm" class="content">
        <!-- PIN Account select -->
        <div class="input-group">
          <label for="pin_account_id">PIN Account</label>
          <select id="pin_account_id" required></select>
        </div>

        <!-- Category select -->
        <div class="input-group">
          <label for="category_id">Category</label>
          <select id="category_id">
            <option value="">(None)</option>
          </select>
        </div>

        <!-- Title input -->
        <div class="input-group">
          <label for="title">Title</label>
          <input id="title" required />
        </div>

        <!-- Description text area -->
        <div class="input-group">
          <label for="description">Description</label>
          <textarea id="description" rows="4"></textarea>
        </div>

        <!-- Status select -->
        <div class="input-group">
          <label for="status">Status</label>
          <select id="status">
            <option>OPEN</option>
            <option>IN_PROGRESS</option>
            <option>CLOSED</option>
          </select>
        </div>

        <!-- Action buttons -->
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Save</button>
          <a class="btn btn-outline" href="requests.html">Cancel</a>
        </div>
      </form>
    </section>
  </main>

  <!-- JS API helper -->
  <script src="static/js/api.js"></script>
  <script>
    /* Parse URL parameter to get request ID */
    const params = new URLSearchParams(location.search);
    const id = Number(params.get('id'));

    /* Load accounts, categories, and request data */
    async function loadRefsAndData() {
      const [accounts, categories, data] = await Promise.all([
        apiGet('/accounts/'),
        apiGet('/categories/'),
        apiGet(`/requests/${id}`)
      ]);

      // Populate account dropdown
      const accSel = document.getElementById('pin_account_id');
      accSel.innerHTML = accounts
        .map(a => `<option value="${a.id}">${a.email} (${a.role})</option>`)
        .join('');
      accSel.value = data.pin_account_id;

      // Populate category dropdown
      const catSel = document.getElementById('category_id');
      catSel.innerHTML += categories
        .map(c => `<option value="${c.id}">${c.name}</option>`)
        .join('');
      if (data.category_id) catSel.value = data.category_id;

      // Fill in request details
      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('status').value = data.status || 'OPEN';
    }

    /* Handle form submission */
    document.getElementById('frm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Collect updated data
      const dto = {
        pin_account_id: Number(document.getElementById('pin_account_id').value),
        category_id: document.getElementById('category_id').value
          ? Number(document.getElementById('category_id').value)
          : null,
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        status: document.getElementById('status').value
      };

      // Send PATCH request, then redirect to list page
      await apiJson(`/requests/${id}`, 'PATCH', dto);
      location.href = 'requests.html';
    });

    // Initialize when page loads
    loadRefsAndData();
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit Request</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <h2 class="mb-3">Edit Request</h2>
  <form class="vstack gap-3" id="frm">
    <div>
      <label class="form-label">PIN Account</label>
      <select class="form-select" id="pin_account_id" required></select>
    </div>
    <div>
      <label class="form-label">Category</label>
      <select class="form-select" id="category_id">
        <option value="">(None)</option>
      </select>
    </div>
    <div>
      <label class="form-label">Title</label>
      <input class="form-control" id="title" required>
    </div>
    <div>
      <label class="form-label">Description</label>
      <textarea class="form-control" id="description" rows="4"></textarea>
    </div>
    <div>
      <label class="form-label">Status</label>
      <select class="form-select" id="status">
        <option>OPEN</option>
        <option>IN_PROGRESS</option>
        <option>CLOSED</option>
      </select>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-secondary" href="requests.html">Back</a>
    </div>
  </form>

  <script src="static/js/api.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const id = Number(params.get('id'));

    async function loadRefsAndData() {
      const [accounts, categories, data] = await Promise.all([
        apiGet('/accounts/'),
        apiGet('/categories/'),
        apiGet(`/requests/${id}`)
      ]);

      const accSel = document.getElementById('pin_account_id');
      accSel.innerHTML = accounts.map(a => `<option value="${a.id}">${a.email} (${a.role})</option>`).join('');
      accSel.value = data.pin_account_id;

      const catSel = document.getElementById('category_id');
      catSel.innerHTML += categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      if (data.category_id) catSel.value = data.category_id;

      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('status').value = data.status || 'OPEN';
    }

    document.getElementById('frm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dto = {
        pin_account_id: Number(document.getElementById('pin_account_id').value),
        category_id: document.getElementById('category_id').value ? Number(document.getElementById('category_id').value) : null,
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        status: document.getElementById('status').value
      };
      await apiJson(`/requests/${id}`, 'PATCH', dto);
      location.href = 'requests.html';
    });

    loadRefsAndData();
  </script>
  </body>
</html>
